<!DOCTYPE html>
<html lang="en" 
      xmlns:th="http://www.thymeleaf.org" 
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Bus Pass Management Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" 
          rel="stylesheet" 
          crossorigin="anonymous">
    <style>
        :root {
            --surface: rgba(255, 255, 255, 0.95);
            --surface-border: rgba(255, 255, 255, 0.2);
            --text: #212529;
            --accent: #0d6efd;
            --bg: #1a1a2e;
        }
        [data-theme="dark"] {
            --surface: rgba(16, 18, 27, 0.8);
            --surface-border: rgba(255, 255, 255, 0.08);
            --text: #e9ecef;
            --accent: #66b2ff;
            --bg: #0f1020;
        }
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            position: relative;
            background-color: var(--bg);
            min-height: 100vh;
        }
        
        #background-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }

        .content-wrapper {
            padding: 40px 0;
            z-index: 1;
        }

        .main-content {
            padding: 30px;
            border-radius: 1rem;
            background-color: var(--surface);
            backdrop-filter: blur(8px);
            border: 1px solid var(--surface-border);
            box-shadow: 0 8px 30px rgba(0,0,0,0.1);
            color: var(--text);
        }

        .contact-footer {
            background-color: rgba(0,0,0,0.2);
            color: #f8f9fa;
        }

        /* Card interactivity */
        .card {
            transition: transform 160ms ease, box-shadow 160ms ease;
            will-change: transform;
        }
        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 14px 30px rgba(0,0,0,0.18);
        }
        .tilt {
            transform-style: preserve-3d;
        }
        .tilt .card-body > * {
            transform: translateZ(14px);
        }

        /* Theme toggle */
        .theme-toggle {
            border: 1px solid var(--surface-border);
            color: var(--text);
        }
        .theme-toggle:hover {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }
    </style>
</head>
<body>

<canvas id="background-canvas"></canvas>

<div class="container content-wrapper">
    <div class="main-content">
        <!-- Header and Welcome -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div class="d-flex align-items-center">
                <a th:href="@{/profile/edit}" sec:authorize="hasAuthority('ROLE_USER')" class="btn btn-outline-secondary me-3" title="Edit Profile">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-gear-fill" viewBox="0 0 16 16">
                        <path d="M9.405 1.05c-.413-1.4-2.397-1.4-2.81 0l-.1.34a1.464 1.464 0 0 1-2.105.872l-.31-.17c-1.283-.698-2.686.705-1.987 1.987l.169.311c.446.82.023 1.841-.872 2.105l-.34.1c-1.4.413-1.4 2.397 0 2.81l.34.1a1.464 1.464 0 0 1 .872 2.105l-.17.31c-.698 1.283.705 2.686 1.987 1.987l.311-.169a1.464 1.464 0 0 1 2.105.872l.1.34c.413 1.4 2.397 1.4 2.81 0l.1-.34a1.464 1.464 0 0 1 2.105-.872l.31.17c1.283.698 2.686-.705 1.987-1.987l-.169-.311a1.464 1.464 0 0 1 .872-2.105l.34-.1c1.4-.413 1.4-2.397 0-2.81l-.34-.1a1.464 1.464 0 0 1-.872-2.105l.17-.31c.698-1.283-.705-2.686-1.987-1.987l-.311.169a1.464 1.464 0 0 1-2.105-.872l-.1-.34zM8 10.93a2.929 2.929 0 1 1 0-5.86 2.929 2.929 0 0 1 0 5.858z"/>
                    </svg>
                </a>
                <h1 class="display-6 mb-0">
                    Welcome, 
                    <span th:text="${user != null ? user.name : #authentication.name}" class="text-primary">User</span>! 
                </h1>
            </div>
            <div class="text-end">
                <span class="badge bg-secondary me-3">
                    Role: <span th:text="${user != null && user.role.name() == 'ADMIN' ? 'ADMIN' : 'Student'}">ROLE</span>
                </span>
                <button id="themeBtn" type="button" class="btn btn-sm btn-outline-secondary theme-toggle me-2">Toggle Theme</button>
                <a th:href="@{/logout}" class="btn btn-outline-danger">Logout</a>
            </div>
        </div>
        
        <hr/>
        
        <!-- Success/Error Messages -->
        <div th:if="${successMessage}" class="alert alert-success" th:text="${successMessage}"></div>
        <div th:if="${errorMessage}" class="alert alert-danger" th:text="${errorMessage}"></div>

        <!-- MAIN DASHBOARD CONTENT -->
        <div class="row g-4 mt-3">
            <!-- Student Cards -->
            <div sec:authorize="hasAuthority('ROLE_USER')" class="col-md-6 col-lg-4">
                <div class="card h-100 border-success shadow-sm tilt">
                    <div class="card-body d-flex flex-column">
                        <h5 class="card-title text-success">My Pass & Payments</h5>
                        <p class="card-text">View your digital bus pass, select route, and pay installment fees.</p>
                        <div class="mt-auto">
                            <a th:href="@{/pass}" class="btn btn-success w-100 mb-2 shadow-sm">View My Bus Pass</a>
                            <a th:href="@{/payments/installments}" class="btn btn-outline-success w-100">Pay Installments</a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Driver/Admin Actions -->
            <div sec:authorize="hasAnyAuthority('ROLE_ADMIN', 'ROLE_DRIVER')" class="col-md-6 col-lg-4">
                <div class="card h-100 border-warning shadow-sm tilt">
                    <div class="card-body d-flex flex-column">
                        <h5 class="card-title text-warning">Post Notices</h5>
                        <p class="card-text">Send urgent updates (delays, schedule changes) to all students.</p>
                        <div class="mt-auto">
                            <a th:href="@{/notices/add}" class="btn btn-warning w-100">Post New Notice</a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Admin Tools -->
            <div sec:authorize="hasAuthority('ROLE_ADMIN')" class="col-md-6 col-lg-4">
                <div class="card h-100 border-danger shadow-sm tilt">
                    <div class="card-body d-flex flex-column">
                        <h5 class="card-title text-danger">Administrator Tools</h5>
                        <p class="card-text">Manage users, routes, installments, and payment configurations.</p>
                        <div class="mt-auto">
                            <a th:href="@{/drivers}" class="btn btn-danger w-100 mb-2">Manage Drivers</a>
                            <a th:href="@{/buses}" class="btn btn-outline-danger w-100 mb-2">Manage Buses & Routes</a>
                            <a th:href="@{/route-installments}" class="btn btn-outline-danger w-100 mb-2">Manage Route Installments</a>
                            <a th:href="@{/payments}" class="btn btn-outline-danger w-100 mb-2">View Payment History</a>
                            <a th:href="@{/faq/manage}" class="btn btn-outline-danger w-100">Manage FAQs</a>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Common Cards for All Users -->
             <div class="col-md-6 col-lg-4">
                <div class="card h-100 border-info shadow-sm tilt">
                    <div class="card-body d-flex flex-column">
                        <h5 class="card-title text-info">Live Bus Tracking</h5>
                        <p class="card-text">View a real-time map of all active bus locations and their routes.</p>
                        <div class="mt-auto">
                            <a th:href="@{/track}" class="btn btn-info w-100 text-white">Track Buses Now</a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6 col-lg-4">
                <div class="card h-100 border-success shadow-sm tilt">
                    <div class="card-body d-flex flex-column">
                        <h5 class="card-title text-success">View Buses & Routes</h5>
                        <p class="card-text">Browse all buses and their assigned routes and stops.</p>
                        <div class="mt-auto">
                            <a th:href="@{/buses}" class="btn btn-success w-100">View Buses & Routes</a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6 col-lg-4">
                <div class="card h-100 border-dark shadow-sm tilt">
                    <div class="card-body d-flex flex-column">
                        <h5 class="card-title text-dark">View Notices</h5>
                        <p class="card-text">See important updates about schedules, delays, and announcements.</p>
                        <div class="mt-auto">
                            <a th:href="@{/notices}" class="btn btn-dark w-100">View Notices</a>
                        </div>
                    </div>
                </div>
            </div>
             <div class="col-md-6 col-lg-4">
                <div class="card h-100 border-secondary shadow-sm">
                    <div class="card-body d-flex flex-column">
                        <h5 class="card-title text-secondary">Driver Details</h5>
                        <p class="card-text">Access contact information for all bus drivers.</p>
                        <div class="mt-auto">
                           <a th:href="@{/drivers}" class="btn btn-secondary w-100">View Driver Info</a>
                        </div>
                    </div>
                </div>
            </div>
             <div class="col-md-6 col-lg-4">
                <div class="card h-100 border-primary shadow-sm">
                    <div class="card-body d-flex flex-column">
                        <h5 class="card-title text-primary">Help & Support</h5>
                        <p class="card-text">Find answers to common questions about bus routes, payments, and pass renewals.</p>
                        <div class="mt-auto">
                             <a th:href="@{/faq}" class="btn btn-primary w-100">Visit FAQ</a>
                        </div>
                    </div>
                </div>
            </div>

        </div> <!-- /row -->

        <!-- Contact Details Section -->
        <div class="mt-5 p-4 rounded contact-footer">
            <h4 class="text-white">Contact Information</h4>
            <hr class="text-white-50">
            <div class="row">
                <div class="col-md-12 mb-3">
                    <p class="mb-1"><strong>College Of Engineering Vadakara</strong></p>
                    <p class="text-white-50 mb-0">Mandarathore (Post), Vatakara, Kozhikode (Dist)</p>
                    <p class="text-white-50">Kerala, India â€“ 673105</p>
                </div>
                <div class="col-md-6">
                    <p class="mb-1"><strong>College Transportation Office:</strong></p>
                    <p class="text-white-50">(+91) 987-654-3210</p>
                </div>
                <div class="col-md-6">
                    <p class="mb-1"><strong>Bus Service Email:</strong></p>
                    <p class="text-white-50">transport@college-email.com</p>
                </div>
            </div>
        </div>

    </div> <!-- /main-content -->
</div> <!-- /container -->

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

<!-- JavaScript for the animated route map -->
<script>
    const canvas = document.getElementById('background-canvas');
    const ctx = canvas.getContext('2d');

    let width, height;
    const dots = [];
    const buses = [];
    const dotCount = 200;
    const busCount = 10;
    const routes = [
        [{x: 0.1, y: 0.2}, {x: 0.4, y: 0.8}, {x: 0.9, y: 0.3}],
        [{x: 0.8, y: 0.1}, {x: 0.2, y: 0.5}, {x: 0.8, y: 0.9}],
        [{x: 0.2, y: 0.9}, {x: 0.9, y: 0.6}, {x: 0.1, y: 0.1}]
    ];

    function resizeCanvas() {
        width = canvas.width = window.innerWidth;
        height = canvas.height = window.innerHeight;
    }

    class Dot {
        constructor() {
            this.x = Math.random() * width;
            this.y = Math.random() * height;
            this.radius = Math.random() * 1.5;
            this.alpha = Math.random() * 0.5 + 0.2;
        }

        draw() {
            ctx.beginPath();
            ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
            ctx.fillStyle = `rgba(255, 255, 255, ${this.alpha})`;
            ctx.fill();
        }
    }
    
    class Bus {
        constructor() {
            this.route = routes[Math.floor(Math.random() * routes.length)];
            this.segment = 0;
            this.progress = Math.random();
            this.speed = Math.random() * 0.002 + 0.001;
        }

        update() {
            this.progress += this.speed;
            if (this.progress >= 1) {
                this.progress = 0;
                this.segment = (this.segment + 1) % this.route.length;
            }
        }

        draw() {
            const start = this.route[this.segment];
            const end = this.route[(this.segment + 1) % this.route.length];
            
            const currentX = (start.x + (end.x - start.x) * this.progress) * width;
            const currentY = (start.y + (end.y - start.y) * this.progress) * height;

            ctx.beginPath();
            ctx.arc(currentX, currentY, 3, 0, Math.PI * 2);
            ctx.fillStyle = '#0d6efd';
            ctx.shadowColor = '#0d6efd';
            ctx.shadowBlur = 10;
            ctx.fill();
            ctx.shadowBlur = 0;
        }
    }

    function init() {
        for (let i = 0; i < dotCount; i++) {
            dots.push(new Dot());
        }
        for (let i = 0; i < busCount; i++) {
            buses.push(new Bus());
        }
    }

    function animate() {
        ctx.clearRect(0, 0, width, height);
        dots.forEach(dot => dot.draw());
        ctx.strokeStyle = 'rgba(13, 110, 253, 0.2)';
        ctx.lineWidth = 1;
        routes.forEach(route => {
            ctx.beginPath();
            ctx.moveTo(route[0].x * width, route[0].y * height);
            for(let i = 1; i < route.length; i++) {
                ctx.lineTo(route[i].x * width, route[i].y * height);
            }
            ctx.closePath();
            ctx.stroke();
        });
        buses.forEach(bus => {
            bus.update();
            bus.draw();
        });
        requestAnimationFrame(animate);
    }

    window.addEventListener('resize', () => {
        resizeCanvas();
        dots.length = 0;
        buses.length = 0;
        init();
    });

    resizeCanvas();
    init();
    animate();

    // Card tilt interaction
    document.querySelectorAll('.tilt').forEach(card => {
        const strength = 10;
        const rect = () => card.getBoundingClientRect();
        card.addEventListener('mousemove', (e) => {
            const r = rect();
            const cx = r.left + r.width / 2;
            const cy = r.top + r.height / 2;
            const dx = (e.clientX - cx) / (r.width / 2);
            const dy = (e.clientY - cy) / (r.height / 2);
            card.style.transform = `rotateY(${dx * strength}deg) rotateX(${dy * -strength}deg)`;
        });
        card.addEventListener('mouseleave', () => {
            card.style.transform = '';
        });
    });

    // Theme toggle with persistence
    const root = document.documentElement;
    const themeBtn = document.getElementById('themeBtn');
    const storedTheme = localStorage.getItem('theme');
    if (storedTheme) {
        root.setAttribute('data-theme', storedTheme);
    }
    themeBtn.addEventListener('click', () => {
        const current = root.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
        root.setAttribute('data-theme', current);
        localStorage.setItem('theme', current);
    });
</script>

</body>
</html>

